pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        spec:
          containers:
          - name: maven
            image: docker.io/javapig/demo-app:maven-agent
            command:
            - cat
            tty: true
            securityContext:
              runAsUser: 0
            magePullPolicy: Always
          - name: python-podman
            image: docker.io/javapig/demo-app:non-root-jenkins-agent-python-gettext
            command:
            - cat
            tty: true
            securityContext:
              runAsUser: 0
            magePullPolicy: Always
          imagePullSecrets:
          - name: my-registry-key
        '''
    }
  }
   stages {
     stage('Maven build') {
            steps {
              container('maven') {
                sh "mvn clean package"
              }
            }      
     }
    stage('Run build image') {
            steps {
              withCredentials([usernamePassword(credentialsId: 'dockerhub-acc', passwordVariable: 'PASS', usernameVariable: 'USER')]) {
              container('python-podman') {
                sh "ls"
                sh "echo Dockerfile-OCP"
                sh "podman version"
                sh "podman build -t docker.io/javapig/demo-app:podman-app ."
                sh "echo $PASS | podman login -u $USER --password-stdin docker.io "
                sh "podman images"
                sh "podman push docker.io/javapig/demo-app:podman-app"
              }
              }
            }      
     }
   }
}
